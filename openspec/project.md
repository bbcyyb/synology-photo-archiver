# 项目背景

## 目的
本项目旨在开发一个 Python 程序，用于定时自动收集群晖 NAS 中新增的照片，将这些照片使用 7z 进行加密切片打包，并存储到群晖内部指定目录，以实现照片的自动化归档和备份。关键路径、密码和目标位置都应是可配置的，且整个过程需要保证幂等性，确保重复执行不会产生副作用或重复归档。

## 技术栈
- Python 3
- 7-Zip (7z 命令行工具)
- Linux (群晖 DSM 环境)

## 项目约定

### 代码风格
- 遵循 **PEP 8** 标准作为主要的 Python 代码风格指南。
- 使用 **Black** 工具进行代码自动格式化，以确保风格统一。
- 使用 **Flake8** 或 **Ruff** 进行代码质量检查（Linting）。
- 所有代码标识符（变量、函数、类名）使用有意义的英文命名。

### 架构模式
- 采用 **模块化脚本架构**。
- 主程序 `archiver.py` 负责整体流程控制。
- 核心功能（如配置读取、文件扫描、7z调用、状态管理）将被拆分为独立的函数或类，并组织在不同的模块中，以提高可维护性和可测试性。
- 例如，我们可以创建一个 `Archiver` 类，封装所有与归档相关的逻辑。
- **配置文件**: 使用 `config.ini` 或类似格式的文本文件来管理所有可配置项，包括照片源目录、归档目标目录、7z 密码和程序状态文件的位置。
- **状态管理与幂等性**: 为了实现幂等性，程序将维护一个状态文件（例如 `last_run.json`）。此文件记录了上次成功处理的所有文件的列表及其修改时间。每次运行时，程序会：1. 读取状态文件。 2. 扫描源目录，并与状态文件中的记录进行比对，只选择未被处理过的新增或修改文件。 3. 成功归档后，更新状态文件。这种机制确保了对同一目录的多次操作结果完全一致。

### 测试策略
- 使用 **pytest** 作为测试框架。
- **单元测试**: 针对每个核心功能模块（如文件扫描逻辑、日期比较函数）编写单元测试。
- **集成测试**: 创建一个模拟的文件环境，测试从“扫描新文件”到“成功生成压缩包”的完整工作流程。我们会模拟 `7z` 的命令行调用，而不是真的执行它。
- 测试代码与源代码分离，存放在 `tests/` 目录下。

### Git 工作流程
- 采用简化的 **功能分支工作流** (Feature Branch Workflow)。
- `main` 分支：用于存放稳定、可随时部署的版本。
- `feature/<name>` 分支：用于开发新功能或修复，每个任务一个分支。开发完成后，通过 Pull Request (PR) 合并回 `main` 分支。
- Commit messages 遵循 **Conventional Commits** 规范，例如 `feat: Add new photo scanning module` 或 `fix: Correctly handle spaces in file paths`。

## 领域背景
项目运行在群晖 NAS 的 Linux 环境中，需要访问本地文件系统以读取照片和写入加密归档。对 7-Zip 命令行工具的调用是核心功能，用于实现打包、加密和切片。程序需要能够识别新的照片，并记录处理状态，避免重复处理。

## 重要约束
- **环境限制**: 运行环境为群晖 DSM 内的 Linux，可能存在特定的 Python 版本和库限制。
- **7-Zip 可用性**: 依赖群晖系统预装或可手动安装的 7z 命令行工具。
- **权限管理**: 程序需要适当的文件读写权限才能访问照片源目录和目标归档目录。
- **资源占用**: 作为一个定时任务，需要考虑其对 NAS 性能的影响，尽量保持低资源占用。
- **安全性**: 7z 加密的密码需要通过配置文件进行安全管理，避免硬编码在代码中。

## 外部依赖
- 7-Zip (7z 命令行工具)